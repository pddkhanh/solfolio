FROM node:22-alpine
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Enable pnpm
RUN corepack enable pnpm

# Setup pnpm environment
ENV PNPM_HOME="/root/.local/share/pnpm"
ENV PATH="${PNPM_HOME}:${PATH}"
ENV SHELL="/bin/sh"

# Create pnpm home directory
RUN mkdir -p ${PNPM_HOME} && \
    pnpm config set global-bin-dir ${PNPM_HOME}

# Copy package files
COPY package.json ./

# Install dependencies including dev dependencies
RUN pnpm install --frozen-lockfile=false

# Copy prisma schema and generate client
COPY prisma ./prisma/
RUN pnpm exec prisma generate

# Install NestJS CLI globally
RUN pnpm add -g @nestjs/cli

EXPOSE 3001 50051

# Copy startup script
COPY start-dev.sh ./

# Run the app
CMD ["./start-dev.sh"]